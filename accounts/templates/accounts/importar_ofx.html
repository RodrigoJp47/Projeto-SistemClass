{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importar OFX - Gestão Financeira</title>
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/themes.css' %}">
    {% comment %} Arquivo CSS dedicado para esta página {% endcomment %}
    <link rel="stylesheet" href="{% static 'css/importar_ofx.css' %}">
    <link rel="stylesheet" href="{% static 'css/layout-responsive.css' %}">
</head>
<body class="importar-ofx-page">
   {% include 'accounts/_sidebar.html' %}

    <div class="main-content">
        <button id="menu-toggle">&#9776;</button>

        <div class="page-header">
            <h1 class="section-title">Integrações</h1>
        </div>

        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <p class="{% if message.tags %}{{ message.tags }}{% endif %}">{{ message }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <div class="form-container">
            <h3>Selecione a Conta e o Arquivo OFX</h3>
            <p class="description">
                Faça o upload do seu arquivo de extrato no formato OFX. O sistema irá ler as transações,
                identificando débitos (que serão enviados para 'Contas a Pagar') e créditos (que irão
                para 'Contas a Receber'), ambos com status 'Em Aberto' para sua conferência.
            </p>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="{{ ofx_form.bank_account.id_for_label }}">Conta Bancária de Destino:</label>
                    {{ ofx_form.bank_account }}
                    {% if ofx_form.bank_account.errors %}
                        <div class="form-error">{{ ofx_form.bank_account.errors|first }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ ofx_form.file.id_for_label }}">Arquivo OFX:</label>
                    {{ ofx_form.file }}
                     {% if ofx_form.file.errors %}
                        <div class="form-error">{{ ofx_form.file.errors|first }}</div>
                    {% endif %}
                </div>
                
                <button type="submit" name="import_ofx">Importar Arquivo</button>
            </form>
        </div>
        {% comment %} --- NOVA SECÇÃO CONTA AZUL --- {% endcomment %}
        <div class="form-container conta-azul-integration mt-4"> {# Reutiliza form-container e adiciona classe específica + margem top #}
            <h3>Integração Conta Azul</h3>
            <p class="description">
                Conecte sua conta do Conta Azul para sincronizar automaticamente suas contas a pagar e receber.
            </p>

            {% if user.contaazul_creds %}
                <div class="integration-status success"> {# Classe CSS para status conectado #}
                    <i class="fas fa-check-circle"></i> {# Ícone FontAwesome #}
                    <span>Sua conta Conta Azul está conectada!</span>
                    {# <a href="#" class="disconnect-link">Desconectar</a> #} {# Link para desconectar (implementação futura) #}
                </div>
            {% else %}
                <a href="{% url 'contaazul_auth' %}" class="btn-conta-azul">
                    <i class="fas fa-link"></i> {# Ícone FontAwesome #}
                    Conectar com Conta Azul
                </a>
                <p class="mt-2"><small>Você será redirecionado para o Conta Azul para autorizar a conexão.</small></p>
            {% endif %}
        </div>
        {% comment %} --- FIM DA NOVA SECÇÃO --- {% endcomment %}
    </div>

    <script src="{% static 'js/theme.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Script para o menu hambúrguer (mobile)
            const menuToggleButton = document.getElementById('menu-toggle');
            const sidebar = document.querySelector('.sidebar');

            if (menuToggleButton && sidebar) {
                menuToggleButton.addEventListener('click', function() {
                    sidebar.classList.toggle('mobile-open');
                });
            }

            // --- LÓGICA DOS SUBMENUS ---
            function setupSubmenuToggle(toggleId, submenuId) {
                const toggleButton = document.getElementById(toggleId);
                const submenu = document.getElementById(submenuId);
                if (toggleButton && submenu) {
                    toggleButton.addEventListener('click', function(event) {
                        event.preventDefault();
                        submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
                    });
                }
            }

            // Inicialização de cada submenu
            setupSubmenuToggle('financeiro-toggle', 'financeiro-submenu');
            setupSubmenuToggle('comercial-toggle', 'comercial-submenu');
            setupSubmenuToggle('configuracoes-toggle', 'configuracoes-submenu');
            

            // Expande o submenu que contém o link ativo na página atual
            const activeLink = document.querySelector('.sidebar .submenu a.active');
            if (activeLink) {
                const parentSubmenu = activeLink.closest('.submenu');
                if (parentSubmenu) {
                    parentSubmenu.style.display = 'block';
                }
            }
        });    
    </script>
</body>
</html>