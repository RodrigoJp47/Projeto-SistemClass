{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importar OFX - Gestão Financeira</title>
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/themes.css' %}">
    {% comment %} Arquivo CSS dedicado para esta página {% endcomment %}
    <link rel="stylesheet" href="{% static 'css/importar_ofx.css' %}">
    <link rel="stylesheet" href="{% static 'css/layout-responsive.css' %}">
</head>

<body class="importar-ofx-page">
    {% include 'accounts/_sidebar.html' %}

    <div class="main-content">
        <button id="menu-toggle">&#9776;</button>

        <div class="page-header">
            <h1 class="section-title">Integrações</h1>
        </div>

        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <p class="{% if message.tags %}{{ message.tags }}{% endif %}">{{ message }}</p>
            {% endfor %}
        </div>
        {% endif %}

        <div class="form-container">
            <h3>Selecione a Conta e o Arquivo OFX</h3>
            <p class="description">
                Faça o upload do seu arquivo de extrato no formato OFX. O sistema irá ler as transações,
                identificando débitos (que serão enviados para 'Contas a Pagar') e créditos (que irão
                para 'Contas a Receber'), ambos com status 'Em Aberto' para sua conferência.
            </p>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="form-group">
                    <label for="{{ ofx_form.bank_account.id_for_label }}">Conta Bancária de Destino:</label>
                    {{ ofx_form.bank_account }}
                    {% if ofx_form.bank_account.errors %}
                    <div class="form-error">{{ ofx_form.bank_account.errors|first }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ ofx_form.file.id_for_label }}">Arquivo OFX:</label>
                    {{ ofx_form.file }}
                    {% if ofx_form.file.errors %}
                    <div class="form-error">{{ ofx_form.file.errors|first }}</div>
                    {% endif %}
                </div>

                <button type="submit" name="import_ofx">Importar Arquivo</button>
            </form>
        </div>
        {% comment %} --- NOVA SECÇÃO CONTA AZUL --- {% endcomment %}
        <div class="form-container conta-azul-integration mt-4"> 
            <h3>Integração Conta Azul</h3>
            <p class="description">
                Conecte sua conta do Conta Azul para sincronizar automaticamente suas contas a pagar e receber.
            </p>

            {% if user.contaazul_creds %}
            <div class="integration-status success"> {# Classe CSS para status conectado #}
                <i class="fas fa-check-circle"></i> {# Ícone FontAwesome #}
                <span>Sua conta Conta Azul está conectada!</span>
                {# <a href="#" class="disconnect-link">Desconectar</a> #} {# Link para desconectar (implementação
                futura) #}
            </div>
            {% else %}
            
            <a href="{% url 'contaazul_auth' %}" class="btn-conta-azul">
                <i class="fas fa-link"></i> {# Ícone FontAwesome #}
                Conectar com Conta Azul
            </a>
            <p class="mt-2"><small>Você será redirecionado para o Conta Azul para autorizar a conexão.</small></p>
            {% endif %}
        </div>
        {% comment %} --- FIM DA NOVA SECÇÃO --- {% endcomment %}

        {% comment %} --- NOVA SECÇÃO BANCO INTER --- {% endcomment %}
        <div class="form-container banco-inter-integration mt-4" style="border-left: 5px solid #FF7A00;"> 
            <div style="display: flex; align-items: center; gap: 10px;">
                
                <h3>Integração Banco Inter</h3>
            </div>
            {% if saldo_inter %}
                <div style="background-color: #fff; border: 1px solid #ddd; border-left: 5px solid #28a745; padding: 10px 15px; margin-bottom: 15px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: bold;">Saldo em Conta</span>
                        <div style="font-size: 24px; font-weight: bold; color: #333;">
                            R$ {{ saldo_inter|floatformat:2|intcomma }}
                        </div>
                    </div>
                    <div style="color: #28a745; font-size: 24px;">
                        <i class="fas fa-wallet"></i>
                    </div>
                </div>
            {% endif %}
            
            <p class="description">
                Sincronize automaticamente o extrato bancário direto da API do Banco Inter (Últimos 7 dias).
            </p>

            {% if user.inter_creds %}
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" name="sync_inter" class="btn-conta-azul" style="background-color: #FF7A00; border-color: #FF7A00; color: white;">
                        <i class="fas fa-sync"></i> Sincronizar Agora
                    </button>
                </form>
                <div style="margin-top: 10px;">
                    <a href="{% url 'configurar_inter' %}" style="color: #666; text-decoration: underline;">Alterar configurações do Inter</a>
                </div>
            {% else %}
            <a href="{% url 'configurar_inter' %}" class="btn-inter">
                <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Banco_Inter_logo.svg" alt="Inter">
                Configurar Banco Inter
            </a>
            {% endif %}
            <p class="mt-2" style="color: #666;"><small>O sistema buscará as transações dos últimos 7 dias.</small></p>
        </div>
        {% comment %} --- FIM DA SECÇÃO --- {% endcomment %}
        {% comment %} --- NOVA SECÇÃO MERCADO PAGO --- {% endcomment %}
        <div class="form-container mercadopago-integration mt-4" style="border-left: 5px solid #009EE3;"> 
            <div style="display: flex; align-items: center; gap: 10px;">
                <img src="https://http2.mlstatic.com/frontend-assets/ui-navigation/5.18.9/mercadolibre/logo__large_plus.png" alt="MP" style="height: 25px; object-fit: contain;">
                <h3>Integração Mercado Pago</h3>
            </div>
            
            {% if saldo_mp is not None %}
                <div style="background-color: #fff; border: 1px solid #ddd; border-left: 5px solid #009EE3; padding: 10px 15px; margin-bottom: 15px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <div>
                        <span style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: bold;">Saldo Disponível</span>
                        <div style="font-size: 24px; font-weight: bold; color: #333;">
                            R$ {{ saldo_mp|floatformat:2|intcomma }}
                        </div>
                    </div>
                    <div style="color: #009EE3; font-size: 24px;">
                        <i class="fas fa-hand-holding-usd"></i>
                    </div>
                </div>
            {% endif %}
            
            <p class="description">
                Sincronize automaticamente suas vendas aprovadas do Mercado Pago (Últimos 7 dias).
            </p>

            {% if user.mercadopago_creds %}
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" name="sync_mp" class="btn-conta-azul" style="background-color: #009EE3; border-color: #009EE3; color: white;">
                        <i class="fas fa-sync"></i> Sincronizar Agora
                    </button>
                </form>
                <div style="margin-top: 10px;">
                    <a href="{% url 'configurar_mercadopago' %}" style="color: #666; text-decoration: underline;">Alterar credenciais MP</a>
                </div>
            {% else %}
                <a href="{% url 'configurar_mercadopago' %}" class="btn-inter" style="border: 1px solid #009EE3; color: #009EE3;">
                    <i class="fas fa-cog"></i> Configurar Mercado Pago
                </a>
            {% endif %}
        </div>
        {% comment %} --- FIM DA SECÇÃO MERCADO PAGO --- {% endcomment %}
        {% comment %} --- NOVA SECÇÃO ASAAS --- {% endcomment %}
        <div class="form-container asaas-integration mt-4" style="border-left: 5px solid #0030b9;"> 
            <div style="display: flex; align-items: center; gap: 10px;">
                <img src="https://logospng.org/download/asaas/logo-asaas-icon-1024.png" alt="Asaas" style="height: 25px; object-fit: contain;">
                <h3>Integração Asaas</h3>
                {% if user.asaas_creds.is_sandbox %}
                    <span style="background: #ffc107; color: #333; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold;">SANDBOX</span>
                {% endif %}
            </div>
            
            {% if saldo_asaas is not None %}
                <div style="background-color: #fff; border: 1px solid #ddd; border-left: 5px solid #0030b9; padding: 10px 15px; margin-bottom: 15px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <div>
                        <span style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: bold;">Saldo Atual</span>
                        <div style="font-size: 24px; font-weight: bold; color: #333;">
                            R$ {{ saldo_asaas|floatformat:2|intcomma }}
                        </div>
                    </div>
                    <div style="color: #0030b9; font-size: 24px;">
                        <i class="fas fa-university"></i>
                    </div>
                </div>
            {% endif %}
            
            <p class="description">
                Importe extrato completo (Cobranças recebidas, Taxas e Transferências) do Asaas.
            </p>

            {% if user.asaas_creds %}
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" name="sync_asaas" class="btn-conta-azul" style="background-color: #0030b9; border-color: #0030b9; color: white;">
                        <i class="fas fa-sync"></i> Sincronizar Agora
                    </button>
                </form>
                <div style="margin-top: 10px;">
                    <a href="{% url 'configurar_asaas' %}" style="color: #666; text-decoration: underline;">Alterar credenciais Asaas</a>
                </div>
            {% else %}
                <a href="{% url 'configurar_asaas' %}" class="btn-inter" style="border: 1px solid #0030b9; color: #0030b9;">
                    <i class="fas fa-cog"></i> Configurar Asaas
                </a>
            {% endif %}
        </div>
        {% comment %} --- FIM DA SECÇÃO ASAAS --- {% endcomment %}
    </div>

    <script src="{% static 'js/theme.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Script para o menu hambúrguer (mobile)
            const menuToggleButton = document.getElementById('menu-toggle');
            const sidebar = document.querySelector('.sidebar');

            if (menuToggleButton && sidebar) {
                menuToggleButton.addEventListener('click', function () {
                    sidebar.classList.toggle('mobile-open');
                });
            }

            // --- LÓGICA DOS SUBMENUS ---
            function setupSubmenuToggle(toggleId, submenuId) {
                const toggleButton = document.getElementById(toggleId);
                const submenu = document.getElementById(submenuId);
                if (toggleButton && submenu) {
                    toggleButton.addEventListener('click', function (event) {
                        event.preventDefault();
                        submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
                    });
                }
            }

            // Inicialização de cada submenu
            setupSubmenuToggle('financeiro-toggle', 'financeiro-submenu');
            setupSubmenuToggle('comercial-toggle', 'comercial-submenu');
            setupSubmenuToggle('configuracoes-toggle', 'configuracoes-submenu');


            // Expande o submenu que contém o link ativo na página atual
            const activeLink = document.querySelector('.sidebar .submenu a.active');
            if (activeLink) {
                const parentSubmenu = activeLink.closest('.submenu');
                if (parentSubmenu) {
                    parentSubmenu.style.display = 'block';
                }
            }
        });    
    </script>
</body>

</html>