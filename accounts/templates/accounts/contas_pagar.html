{% load static %}
{% load humanize %}
{% load l10n %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contas a Pagar - Gest√£o Financeira</title>
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/themes.css' %}">
    <link rel="stylesheet" href="{% static 'css/contas_pagar.css' %}">
    <link rel="stylesheet" href="{% static 'css/layout-responsive.css' %}">

</head>

<body class="contas-pagar-page">

    {% include 'accounts/_sidebar.html' %}
    <div class="main-content">
        {% include 'accounts/partials/bpo_banner.html' %}
        <button id="menu-toggle">&#9776;</button>
        <div class="header-container">
            <h1>Contas a Pagar</h1>
        </div>
        {% if messages %}
        <ul class="messages">
            {% for message in messages %}
            <li{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</li>
                {% endfor %}
        </ul>
        {% endif %}
        <div class="form-container">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {% if form.instance.id %}
                <input type="hidden" name="account_id" value="{{ form.instance.id|unlocalize }}">
                {% endif %}
                <div style="margin-bottom: 15px; padding: 10px; background-color: #2c3e50; border-radius: 5px; border-left: 4px solid #3498db;">
                    <strong style="color: white; display: block; margin-bottom: 5px;">ü§ñ Automa√ß√£o:</strong>
                    <label for="boleto-upload" class="btn btn-primary" style="cursor: pointer; background-color: #3498db; border: none;">
                        <i class="fas fa-file-pdf"></i> Carregar Boleto (PDF) e Preencher
                    </label>
                    <input type="file" id="boleto-upload" accept="application/pdf" style="display: none;">
                    <span id="boleto-loading" style="color: #ccc; margin-left: 10px; display: none;">Lendo arquivo... aguarde...</span>
                </div>
                {{ form.name.label_tag }} {{ form.name }}
                {{ form.description.label_tag }} {{ form.description }}
                <label for="id_due_date">Data de vencimento:</label>
                <input type="date" name="due_date" id="id_due_date" {% if form.instance.due_date %}value="{{ form.instance.due_date|date:'Y-m-d' }}"{% endif %} required>
                <label for="id_amount">Valor:</label>
                <input type="text" name="amount" id="id_amount" {% if form.instance.amount %}value="{{ form.instance.amount|floatformat:2|intcomma }}"{% endif %} required>
                <div class="form-group-custom" style="margin-bottom: 15px; width: 100%;">
                <label style="display: block; margin-bottom: 5px;">Categoria:</label>
                <div style="display: flex; gap: 8px; align-items: center; width: 100%;">
                        <input type="text" id="category-display" class="form-field-category" 
                            placeholder="Clique para selecionar ou criar..." readonly 
                            onclick="abrirModalCategoria()"
                            value="{% if form.instance.category %}{{ form.instance.category.name }}{% endif %}"
                            style="flex: 1; height: 42px; padding: 10px; border-radius: 4px; cursor: pointer;">
                        
                        <button type="button" class="btn-manage-cat" onclick="abrirModalCategoria()" 
                                style="padding: 0 20px; height: 42px; background-color: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; font-weight: bold;">
                            Gerenciar
                        </button>
                    </div>

                    <div style="display:none;">
                        {{ form.category }}
                        {{ form.new_category }}
                    </div>
                </div>

                
                {{ form.dre_area.label_tag }} <label for="id_dre_area">√Årea-DRE:</label>
                    <select name="dre_area" id="id_dre_area" required>
                        <option value="" selected disabled>Selecione...</option>
                        
                        <option value="DEDUCAO" {% if form.dre_area.value == "DEDUCAO" %}selected{% endif %}>Dedu√ß√£o da Receita Bruta (-)</option>

                        <option value="CUSTOS" {% if form.dre_area.value == "CUSTOS" %}selected{% endif %}>Custos CSP/CMV (-)</option>

                        <option value="OPERACIONAL" {% if form.dre_area.value == "OPERACIONAL" %}selected{% endif %}>Despesas Operacionais (-)</option>
                        <option value="DEPRECIACAO" {% if form.dre_area.value == "DEPRECIACAO" %}selected{% endif %}>Deprecia√ß√£o e Amortiza√ß√£o (-)</option>

                        <option value="NAO_OPERACIONAL" {% if form.dre_area.value == "NAO_OPERACIONAL" %}selected{% endif %}>Despesas N√£o Operacionais (-)</option>
                        <option value="TRIBUTACAO" {% if form.dre_area.value == "TRIBUTACAO" %}selected{% endif %}>IRPJ e CSLL (Tributa√ß√£o) (-)</option>
                        
                        <option value="DISTRIBUICAO" {% if form.dre_area.value == "DISTRIBUICAO" %}selected{% endif %}>Distribui√ß√£o de Lucro S√≥cios (-)</option>
                        <option value="RETIRADA_SOCIOS" {% if form.dre_area.value == "RETIRADA_SOCIOS" %}selected{% endif %}>Retirada de S√≥cios (-)</option>
                        
                        <option value="NAO_CONSTAR" {% if form.dre_area.value == "NAO_CONSTAR" %}selected{% endif %}>N√£o constar DRE</option>
                    </select>
                <div style="margin-top: 10px; margin-bottom: 10px; border-top: 1px dashed #ccc; padding-top: 10px;">
                    <label for="id_centro_custo">Centro de Custo:</label>
                    {{ form.centro_custo }}
                    
                    <label for="id_new_centro_custo" style="margin-left: 10px;">Novo Centro de Custo:</label>
                    {{ form.new_centro_custo }}
                </div>    
                {{ form.payment_method.label_tag }} {{ form.payment_method }}
                {{ form.occurrence.label_tag }} {{ form.occurrence }}
                {{ form.recurrence_count.label_tag }} {{ form.recurrence_count }}
                {{ form.cost_type.label_tag }} {{ form.cost_type }}
                {{ form.bank_account.label_tag }} {{ form.bank_account }}
                {{ form.file.label_tag }} {{ form.file }}
                <button type="submit" name="save" class="btn btn-primary">Salvar</button>
                <button type="submit" name="save_and_pay" class="btn btn-primary">Salvar e Pagar</button>
            </form>
        </div>

        <div class="filter-container">
            <form method="get">
                <label for="status">Filtrar por status:</label>
                <select name="status" id="status">
                    <option value="all" {% if filter_status == 'all' %}selected{% endif %}>Todas</option>
                    <option value="open" {% if filter_status == 'open' %}selected{% endif %}>Abertas</option>
                    <option value="paid" {% if filter_status == 'paid' %}selected{% endif %}>Pagas</option>
                </select>
                
                <label for="bank">Filtrar por banco:</label>
                <select name="bank" id="bank">
                    <option value="" {% if bank_filter == '' %}selected{% endif %}>Todos os Bancos</option>
                    {% for bank in user_banks %}
                        <option value="{{ bank.id }}" {% if bank_filter == bank.id|stringformat:"s" %}selected{% endif %}>
                            {{ bank.bank_name }}
                        </option>
                    {% endfor %}
                </select>

                <label for="start_date">Data inicial:</label>
                <input type="date" name="start_date" id="start_date" value="{{ start_date|default_if_none:'' }}">
                <label for="end_date">Data final:</label>
                <input type="date" name="end_date" id="end_date" value="{{ end_date|default_if_none:'' }}">
                <label for="search_query">Pesquisar:</label>
                <input type="text" name="search_query" id="search_query" value="{{ search_query|default_if_none:'' }}"
                    placeholder="Nome, descri√ß√£o, categoria...">
                <label for="per_page">Registros por p√°gina:</label>
                <select name="per_page" id="per_page">
                    <option value="10" {% if per_page == '10' %}selected{% endif %}>10</option>
                    <option value="20" {% if per_page == '20' %}selected{% endif %}>20</option>
                    <option value="50" {% if per_page == '50' %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == '100' %}selected{% endif %}>100</option>
                </select>    
                <button type="submit" class="btn btn-primary">Filtrar</button>
            </form>
        </div>
        <form method="post" enctype="multipart/form-data" id="import-form">
            {% csrf_token %}
            <input type="file" name="excel_file" id="excel-upload-input" style="display: none;" accept=".xlsx, .xls">
            <input type="hidden" name="action" value="import_excel">
        </form>

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" name="file" id="file-upload-input" style="display: none;">
            <input type="hidden" name="attach_account_id" id="attach-account-id-input">

            <div class="actions-header">
                <div class="export-buttons">
                    <a href="?export_pdf=1&status={{ filter_status }}&start_date={{ start_date|default_if_none:'' }}&end_date={{ end_date|default_if_none:'' }}"
                        class="btn btn-primary" target="_blank">Exportar para PDF</a>
                    <a href="?export_excel=1&status={{ filter_status }}&start_date={{ start_date|default_if_none:'' }}&end_date={{ end_date|default_if_none:'' }}"
                        class="btn btn-primary">Exportar para Excel</a>
                    <button type="button" id="import-excel-btn" class="btn btn-primary">Importar Planilha</button>
                    <div class="info-tooltip-container">
                        <span class="info-icon">i</span>
                        <div class="tooltip-text"> <strong>Regras para Importa√ß√£o:</strong>
                            <hr>
                            <p>A planilha deve conter as 3 colunas obrigat√≥rias. A ordem n√£o importa.</p>
                            <ul>
                                <li><strong>OBRIGAT√ìRIO (Nome):</strong> T√≠tulo da coluna deve ser 'Nome', 'Cliente' ou
                                    'Fornecedor'.</li>
                                <li><strong>OBRIGAT√ìRIO (Vencimento):</strong> T√≠tulo deve ser 'Vencimento', 'Data do
                                    pagamento' ou 'Data do vencimento'.</li>
                                <li><strong>OBRIGAT√ìRIO (Valor):</strong> T√≠tulo deve ser 'Valor' ou 'Pagamento'.</li>
                                <li><strong>Opcionais:</strong> 'Descri√ß√£o', 'Categoria', 'Banco', 'Forma de pagamento',
                                    'Custo'.</li>
                            </ul>
                            <p>Colunas extras na planilha ser√£o ignoradas.</p>
                        </div>
                    </div>
                </div>
                <div class="bulk-action">
                    <button type="submit" name="delete_selected" class="btn btn-danger"
                        onclick="return confirm('Tem certeza que deseja excluir as contas selecionadas?');">Excluir
                        Selecionados</button>
                </div>
            </div>

            <div class="table-container">
                <table>

                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all"></th>
                            <th>Nome</th>
                            <th>Descri√ß√£o</th>
                            <th>Vencimento</th>
                            <th>Data Pagamento</th>
                            <th>Valor</th>
                            <th>Categoria</th>
                            <th>Centro de Custo</th>
                            <th>Conta Banc√°ria</th>
                            <th>Forma Pag.</th>
                            <th>Status</th>
                            <th style="text-align: center;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for account in accounts %}
                        <tr {% if account.payment_date %}style="background-color: rgba(46, 204, 113, 0.1);" title="Conta Paga"{% endif %}>
                            <td data-label="Selecionar"><input type="checkbox" name="account_ids"
                                    value="{{ account.id|unlocalize }}" class="select-item"></td>
                            <td data-label="Nome">{{ account.name }}</td>
                            <td data-label="Descri√ß√£o">{{ account.description }}</td>
                            <td data-label="Vencimento">{{ account.due_date|date:"d/m/Y" }}</td>
                            <td data-label="Data Pagamento">
                                {% if account.payment_date %}
                                    {{ account.payment_date|date:"d/m/Y" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td data-label="Valor">R$ {{ account.amount|intcomma }}</td>
                            <td data-label="Categoria">{{ account.category.name|default:"-" }}</td>
                            <td data-label="Centro de Custo">{{ account.centro_custo.nome|default:"-" }}</td>
                            <td data-label="Conta Banc√°ria">{{ account.bank_account|default:"-" }}</td>
                            <td data-label="Forma Pag.">{{ account.get_payment_method_display }}</td>
                            <td data-label="Status">
                                {% if account.is_paid %}
                                {% if account.ofx_import %}
                                <span style="color: #007bff; font-weight: bold;">Pago (OFX)</span>
                                {% else %}
                                Pago
                                {% endif %}
                                {% else %}
                                Aberto
                                {% endif %}
                            </td>
                            <td data-label="A√ß√µes" class="actions-cell">
                                <div class="action-menu">
                                    <div class="menu-icon">...</div>
                                    <div class="dropdown">

                                        {% if not account.is_paid %}
                                        <button type="submit" name="action_pay" value="{{ account.id|unlocalize }}"
                                            title="Baixar">&#10004;</button>
                                        {% else %}
                                        <button type="submit" name="action_undo" value="{{ account.id|unlocalize }}"
                                            class="undo-btn" title="Desfazer">&#8634;</button>
                                        {% endif %}

                                        <a href="?edit={{ account.id|unlocalize }}&status={{ filter_status }}&bank={{ bank_filter }}&search_query={{ search_query|default:'' }}&page={{ accounts.number }}&start_date={{ start_date|default:'' }}&end_date={{ end_date|default:'' }}" title="Editar">&#9998;</a>

                                        <button type="button" onclick="triggerFileUpload('{{ account.id|unlocalize }}')"
                                            title="Anexar arquivo">&#128206;</button>

                                        <button type="submit" name="action_delete"
                                            value="{{ account.id|unlocalize }}" class="delete-btn"
                                            onclick="return confirm('Tem certeza que deseja excluir esta conta?');"
                                            title="Excluir">&#128465;</button>

                                        {% if account.file %}
                                            <button type="submit" name="action_delete_file"
                                                value="{{ account.id|unlocalize }}"
                                                style="color: #ff9800; font-weight: bold;"
                                                onclick="return confirm('Deseja remover apenas o anexo PDF desta conta?');"
                                                title="Remover Anexo (PDF)">&#10060;</button>

                                            <a href="{{ account.file.url }}" target="_blank" title="Ver PDF">&#128065;</a>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" style="text-align: center;">Nenhuma conta encontrada.</td>
                        </tr>
                        {% endfor %}
                        <tr class="total-row">
                            <td colspan="4" style="text-align: right; font-weight: bold;">TOTAL DO PER√çODO:</td>
                            <td style="font-weight: bold; white-space: nowrap;">R$ {{ total_amount|floatformat:2|intcomma }}</td>
                            <td colspan="6"></td> {# C√©lula vazia para preencher as colunas restantes #}
                        </tr>
                    </tbody>
                </table>

                <div class="pagination">
                    {% if accounts.has_other_pages %}
                        {% if accounts.has_previous %}
                            <a href="?page=1&status={{ filter_status }}&bank={{ bank_filter }}&start_date={{ start_date|default:'' }}&end_date={{ end_date|default:'' }}&search_query={{ search_query|default:'' }}&per_page={{ per_page }}">&laquo; Primeira</a>
                            <a href="?page={{ accounts.previous_page_number }}&status={{ filter_status }}&bank={{ bank_filter }}&start_date={{ start_date|default:'' }}&end_date={{ end_date|default:'' }}&search_query={{ search_query|default:'' }}&per_page={{ per_page }}">Anterior</a>
                        {% endif %}
                        <span class="current">
                            P√°gina {{ accounts.number }} de {{ accounts.paginator.num_pages }}.
                        </span>
                        {% if accounts.has_next %}
                            <a href="?page={{ accounts.next_page_number }}&status={{ filter_status }}&bank={{ bank_filter }}&start_date={{ start_date|default:'' }}&end_date={{ end_date|default:'' }}&search_query={{ search_query|default:'' }}&per_page={{ per_page }}">Pr√≥xima</a>
                            <a href="?page={{ accounts.paginator.num_pages }}&status={{ filter_status }}&bank={{ bank_filter }}&start_date={{ start_date|default:'' }}&end_date={{ end_date|default:'' }}&search_query={{ search_query|default:'' }}&per_page={{ per_page }}">√öltima &raquo;</a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
    <div id="categoryModal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8);">
        <div style="margin: 5% auto; padding: 20px; width: 90%; max-width: 450px; border-radius: 8px;">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                <h3 style="margin: 0;">Gerenciar Categorias</h3>
                <span onclick="fecharModalCategoria()" style="cursor: pointer; font-size: 28px;">&times;</span>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px;">Nova Categoria:</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="new-cat-input" placeholder="Nome" style="flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #2c2c2c; color: white;">
                    <button type="button" onclick="criarNovaCategoriaModal()" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Criar</button>
                </div>
            </div>

            <div style="margin-bottom: 10px;">
                <input type="text" id="modal-search" placeholder="Pesquisar..." onkeyup="filtrarCategoriasModal()" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #2c2c2c; color: white; box-sizing: border-box;">
            </div>

            <div style="max-height: 200px; overflow-y: auto; background: #2c2c2c; border-radius: 4px; margin-bottom: 15px; border: 1px solid #444;">
                <ul id="category-list" style="list-style: none; padding: 0; margin: 0; color: white;"> </ul>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <button type="button" onclick="excluirSelecionadosModal()" style="background: #e74c3c; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 13px;">Excluir Selecionados</button>
                <button type="button" onclick="fecharModalCategoria()" style="background: #555; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">Fechar</button>
            </div>
        </div>
    </div>
    <script>
        // Adicione isso logo no in√≠cio do seu <script> para facilitar
        const CSRF_TOKEN = document.querySelector('[name=csrfmiddlewaretoken]').value;
        document.addEventListener('DOMContentLoaded', function () {
            // --- SCRIPT DE LEITURA DE BOLETO E ANEXO AUTOM√ÅTICO ---
            const boletoInput = document.getElementById('boleto-upload');
            const boletoLoading = document.getElementById('boleto-loading');
            
            // IDs dos campos do formul√°rio
            const fieldAmount = document.getElementById('id_amount');
            const fieldDate = document.getElementById('id_due_date');
            const fieldName = document.getElementById('id_name');
            const fieldDesc = document.getElementById('id_description');
            const fieldFile = document.getElementById('id_file'); 
            
            // Novos campos para automa√ß√£o
            const fieldPayment = document.getElementById('id_payment_method');
            const fieldOccurrence = document.getElementById('id_occurrence');
            const fieldBank = document.getElementById('id_bank_account');

            if (boletoInput) {
                boletoInput.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        
                        // 1. Transfere o arquivo para o formul√°rio
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(this.files[0]);
                        if(fieldFile) {
                            fieldFile.files = dataTransfer.files;
                        }

                        // 2. Prepara envio
                        const file = this.files[0];
                        const formData = new FormData();
                        formData.append('boleto_file', file);
                        formData.append('action', 'read_boleto');
                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        formData.append('csrfmiddlewaretoken', csrfToken);

                        boletoLoading.style.display = 'inline';
                        boletoLoading.innerText = 'Lendo PDF...';
                        this.disabled = true;

                        fetch(window.location.href, {
                            method: 'POST',
                            body: formData,
                            headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.status === 'success') {
                                const dados = result.data;
                                
                                // --- PREENCHIMENTO DOS CAMPOS LIDOS ---
                                if (dados.valor && fieldAmount) {
                                    fieldAmount.value = dados.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                                }
                                if (dados.vencimento && fieldDate) {
                                    fieldDate.value = dados.vencimento;
                                }
                                if (dados.fornecedor && fieldName) {
                                    fieldName.value = dados.fornecedor;
                                }
                                let descExtra = "";
                                if (dados.descricao) descExtra += dados.descricao + ". ";
                                if (dados.codigo_barras) descExtra += "\nC√≥d: " + dados.codigo_barras;
                                if (descExtra && fieldDesc) {
                                    fieldDesc.value = descExtra;
                                }

                                // --- AUTOMA√á√ÉO DOS CAMPOS PADR√ÉO (SEU PEDIDO) ---
                                
                                // 1. Define "Boleto"
                                if (fieldPayment) {
                                    // Tenta achar a op√ß√£o pelo valor 'BOLETO'
                                    for(let i=0; i<fieldPayment.options.length; i++){
                                        if(fieldPayment.options[i].value === 'BOLETO') {
                                            fieldPayment.selectedIndex = i;
                                            break;
                                        }
                                    }
                                }

                                // 2. Define "Avulso"
                                if (fieldOccurrence) {
                                    for(let i=0; i<fieldOccurrence.options.length; i++){
                                        if(fieldOccurrence.options[i].value === 'AVULSO') {
                                            fieldOccurrence.selectedIndex = i;
                                            break;
                                        }
                                    }
                                }

                                // 3. Define a Primeira Conta Banc√°ria dispon√≠vel
                                if (fieldBank && fieldBank.options.length > 1) {
                                    // O √≠ndice 0 geralmente √© "--------" (vazio), ent√£o pegamos o 1
                                    fieldBank.selectedIndex = 1; 
                                }

                                alert('Leitura conclu√≠da! Campos preenchidos e padr√µes selecionados.');
                            } else {
                                alert('O arquivo foi anexado, mas n√£o foi poss√≠vel ler os dados automaticamente.');
                            }
                        })
                        .catch(error => {
                            console.error('Erro:', error);
                            alert('Erro ao processar. O arquivo foi anexado.');
                        })
                        .finally(() => {
                            boletoLoading.style.display = 'none';
                            this.disabled = false;
                        });
                    }
                });
            }
            // L√≥gica do menu hamb√∫rguer para mobile
            const menuToggleButton = document.getElementById('menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            if (menuToggleButton && sidebar) {
                menuToggleButton.addEventListener('click', function () {
                    sidebar.classList.toggle('mobile-open');
                });
            }
            // --- IN√çCIO DO SCRIPT DO MENU ---
            function setupSubmenuToggle(toggleId, submenuId) {
                const toggleButton = document.getElementById(toggleId);
                const submenu = document.getElementById(submenuId);
                if (toggleButton && submenu) {
                    toggleButton.addEventListener('click', function (event) {
                        event.preventDefault();
                        submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
                    });
                }
            }
            setupSubmenuToggle('financeiro-toggle', 'financeiro-submenu');
            setupSubmenuToggle('comercial-toggle', 'comercial-submenu');
            setupSubmenuToggle('configuracoes-toggle', 'configuracoes-submenu');

            // Expande o submenu que cont√©m o link ativo na p√°gina atual
            const activeLink = document.querySelector('.sidebar .submenu a.active');
            if (activeLink) {
                const parentSubmenu = activeLink.closest('.submenu');
                if (parentSubmenu) {
                    parentSubmenu.style.display = 'block';
                }
            }
            // --- FIM DO SCRIPT DO MENU ---
            // Script para menu de a√ß√µes individual
            document.querySelectorAll('.menu-icon').forEach(icon => {
                icon.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const menu = this.closest('.action-menu');
                    const isActive = menu.classList.contains('active');
                    document.querySelectorAll('.action-menu').forEach(m => m.classList.remove('active'));
                    if (!isActive) {
                        menu.classList.add('active');
                    }
                });
            });
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.action-menu')) {
                    document.querySelectorAll('.action-menu').forEach(menu => {
                        menu.classList.remove('active');
                    });
                }
            });


            // Script para formatar o valor antes de enviar o formul√°rio
            const form = document.querySelector('.form-container form');
            const amountInput = document.getElementById('id_amount');
            if (form && amountInput) {
                form.addEventListener('submit', function () {
                    let amountValue = amountInput.value;

                    // --- IN√çCIO DA CORRE√á√ÉO ---
                    // S√≥ executa a formata√ß√£o se o valor contiver uma v√≠rgula,
                    // indicando o formato brasileiro (Ex: 1.235,50).
                    if (amountValue.includes(',')) {
                        // Remove os pontos (milhar) e substitui a v√≠rgula (decimal) por ponto.
                        amountValue = amountValue.replace(/\./g, '').replace(',', '.');
                    }
                    // Se n√£o houver v√≠rgula, o script n√£o altera o valor,
                    // permitindo que "235.00" seja enviado corretamente.
                    // --- FIM DA CORRE√á√ÉO ---

                    amountInput.value = amountValue;
                });
            }

            // Script para sele√ß√£o em massa
            const selectAllCheckbox = document.getElementById('select-all');
            const itemCheckboxes = document.querySelectorAll('.select-item');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function () {
                    itemCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                });
            }

            // Script para anexo de arquivo
            const fileUploadInput = document.getElementById('file-upload-input');
            if (fileUploadInput) {
                fileUploadInput.addEventListener('change', function () {
                    if (this.files.length > 0) {
                        // Define o name do bot√£o de anexo para ser identificado na view
                        const attachButton = document.createElement('input');
                        attachButton.type = 'hidden';
                        attachButton.name = 'action_attach';
                        attachButton.value = '1';
                        this.form.appendChild(attachButton);
                        this.form.submit();
                    }
                });
            }
            // ‚ñº‚ñº‚ñº ADICIONE TODO ESTE BLOCO DE C√ìDIGO ABAIXO ‚ñº‚ñº‚ñº
            const importBtn = document.getElementById('import-excel-btn');
            const excelInput = document.getElementById('excel-upload-input');

            if (importBtn && excelInput) {
                importBtn.addEventListener('click', function () {
                    excelInput.click();
                });

                excelInput.addEventListener('change', function () {
                    if (this.files.length > 0) {
                        document.getElementById('import-form').submit();
                    }
                });
            }
            // --- FIM DO BLOCO A SER ADICIONADO ---
            
        });

        function triggerFileUpload(accountId) {
            document.getElementById('attach-account-id-input').value = accountId;
            document.getElementById('file-upload-input').click();
        }
        // --- GERENCIAMENTO DE CATEGORIAS ---
        let todasCategorias = [];

        function abrirModalCategoria() {
            document.getElementById('categoryModal').style.display = 'block';
            carregarCategoriasLista();
        }

        function fecharModalCategoria() {
            document.getElementById('categoryModal').style.display = 'none';
        }

        function carregarCategoriasLista() {
            const list = document.getElementById('category-list');
            list.innerHTML = '<li style="padding: 10px; color: #aaa;">Carregando...</li>';
            fetch('/contas-pagar/categorias/json/?tipo=PAYABLE')
                .then(res => res.json())
                .then(data => {
                    todasCategorias = data;
                    renderizarItensModal(data);
                });
        }

        function renderizarItensModal(dados) {
            const list = document.getElementById('category-list');
            if (dados.length === 0) {
                list.innerHTML = '<li style="padding: 10px; color: #aaa;">Nenhuma encontrada.</li>';
                return;
            }
            list.innerHTML = dados.map(cat => `
                <li style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #3d3d3d;">
                    <span onclick="selecionarCategoriaModal('${cat.id}', '${cat.name}')" style="cursor:pointer; color: #fff; flex: 1;">${cat.name}</span>
                    <input type="checkbox" class="cat-del-check" value="${cat.id}" style="width: 18px; height: 18px; cursor: pointer;">
                </li>
            `).join('');
        }

        function filtrarCategoriasModal() {
            const termo = document.getElementById('modal-search').value.toLowerCase();
            const filtradas = todasCategorias.filter(c => c.name.toLowerCase().includes(termo));
            renderizarItensModal(filtradas);
        }

        function selecionarCategoriaModal(id, nome) {
            document.getElementById('id_category').value = id;
            document.getElementById('category-display').value = nome;
            fecharModalCategoria();
        }

        function criarNovaCategoriaModal() {
            const input = document.getElementById('new-cat-input');
            const nome = input.value.trim();
            if (!nome) return alert('Digite um nome.');
            const formData = new FormData();
            formData.append('name', nome);
            formData.append('tipo', 'PAYABLE');
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            fetch('/contas-pagar/categorias/criar/', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.id) {
                        selecionarCategoriaModal(data.id, data.name);
                        input.value = '';
                    }
                });
        }

        function excluirSelecionadosModal() {
            const selecionados = Array.from(document.querySelectorAll('.cat-del-check:checked')).map(cb => cb.value);
            if (selecionados.length === 0) return alert('Selecione para excluir.');
            if (confirm('Excluir categorias selecionadas?')) {
                const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
                Promise.all(selecionados.map(id => 
                    fetch(`/contas-pagar/categorias/deletar/${id}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrf }
                    })
                )).then(() => carregarCategoriasLista());
            }
        }
    </script>
    <script src="{% static 'js/theme.js' %}"></script>
</body>

</html>